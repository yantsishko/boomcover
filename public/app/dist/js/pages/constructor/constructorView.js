define(["app","marionette","backbone","underscore","pace","text!templates/constructor/index.ejs","subscriber","js/models/widgets/subscriber/subscriberModel","js/models/widgets/dateTime/dateTime","js/models/widgets/dateTime/dateModel","js/models/widgets/text/text","js/models/widgets/text/textModel","js/models/widgets/textUrl/textUrl","js/models/widgets/textUrl/textUrlModel","js/models/widgets/timer/timer","js/models/widgets/timer/timerModel","js/models/widgets/weather/weather","js/models/widgets/weather/weatherModel","js/models/widgets/commentatorLast/commentatorLast","js/models/widgets/commentatorLast/commentatorLastModel","js/models/widgets/commentatorDay/commentatorDay","js/models/widgets/commentatorDay/commentatorDayModel","js/models/widgets/commentatorLikes/commentatorLikes","js/models/widgets/commentatorLikes/commentatorLikesModel","js/models/widgets/winner/winner","js/models/widgets/winner/winnerModel","js/models/widgets/reposterDay/reposterDay","js/models/widgets/reposterDay/reposterDayModel","js/models/widgets/likerDay/likerDay","js/models/widgets/likerDay/likerDayModel","js/models/widgets/reposterLast/reposterLast","js/models/widgets/reposterLast/reposterLastModel","js/models/widgets/courses/courses","js/models/widgets/courses/coursesModel","js/models/widgets/statistic/statistic","js/models/widgets/statistic/statisticModel","js/models/widgets/traffic/traffic","js/models/widgets/traffic/trafficModel","js/models/widgets/image/image","js/models/widgets/image/imageModel","js/models/widgets/activeWidgets/collectionView","js/models/widgets/coverWidgets/collectionView","js/pages/groups/collectionView","jqueryui","notify","nicescroll","spinner","enjoyhint"],function(e,t,i,s,o,a,n,d,c,r,l,w,u,h,f,m,g,k,p,y,$,b,v,j,I,C,D,S,L,x,T,V,M,U,W,O,R,G,E,_,N,F,H,J,P,Z,B,z){"use strict";return t.LayoutView.extend({template:s.template(a),regions:{widgetSettings:"[data-selector=widget-settings]",activeWidgets:"[data-selector=active-widgets]",widgets:"[data-selector=widgets]",groups:"[data-selector=groups]"},ui:{canva:"#constructor"},events:{"click [data-action=add-subscriber]":"addSubscriber","click [data-action=add-winner]":"addWinner","click [data-action=add-text]":"addText","click [data-action=add-textUrl]":"addTextUrl","click [data-action=add-timer]":"addTimer","click [data-action=add-weather]":"addWeather","click [data-action=add-courses]":"addCourses","click [data-action=add-statistic]":"addStatistic","click [data-action=add-date]":"addDate","click [data-action=add-last-commentator]":"addLastCommentator","click [data-action=add-last-reposter]":"addLastReposter","click [data-action=add-day-commentator]":"addDayCommentator","click [data-action=add-day-reposter]":"addDayReposter","click [data-action=add-day-liker]":"addDayLiker","click [data-action=add-likes-commentator]":"addLikesCommentator","click [data-action=add-traffic]":"addTraffic","click [data-action=add-image]":"addImage","click [data-action=save]":"saveWidgets","click [data-action=markup]":"toggleMarkup","click [data-action=preview]":"showPreview","click [data-action=info-subscriber]":"showInfoSubscriber","click [data-action=info-winner]":"showInfoWinner","click [data-action=info-last-comment]":"showInfoCommLast","click [data-action=info-comm-likes]":"showInfoCommLikes","click [data-action=info-comm-day]":"showInfoCommDay","click [data-action=info-reposter-day]":"showInfoReposterDay","click [data-action=info-liker-day]":"showInfoLikerDay","click [data-action=info-reposter-last]":"showInfoReposterLast","click [data-action=info-date]":"showInfoDate","click [data-action=info-timer]":"showInfoTimer","click [data-action=info-weather]":"showInfoWeather","click [data-action=info-text]":"showInfoText","click [data-action=info-textUrl]":"showInfoTextUrl","click [data-action=info-courses]":"showInfoCourses","click [data-action=info-statistic]":"showInfoStatistic","click [data-action=info-traffic]":"showInfoTraffic","click [data-action=info-image]":"showInfoImage","input [name=search-group]":"searchGroup","click #dismiss":"hideSidebar","click .overlay":"hideSidebar","click [data-action=close-info]":"hideAllInfo"},initialize:function(){this.constructorId=window.location.pathname.replace("/constructor/",""),this.files=[],this.userGroups=null,this.userGroupsSearch=null,this.groupData=null,this.userData=null;var t=this;i.$.ajax({async:!1,url:e.url+"/api/v1/groups",success:function(e){t.userGroups=new i.Collection(e),t.userGroupsSearch=new i.Collection(e)},error:function(e){401==e.status&&(window.location="/login")}}),i.$.ajax({async:!1,url:e.url+"/api/v1/group/"+this.constructorId,success:function(e){t.groupData=e.data},error:function(e){i.$.notify("Произошла ошибка","error"),401==e.status&&(window.location="/login")}}),i.$.ajax({async:!1,url:e.url+"/api/v1/current_user",success:function(e){t.userData=e},error:function(e){i.$.notify("Произошла ошибка","error"),401==e.status&&(window.location="/login")}}),this.widgets=new i.Collection,i.$.ajax({async:!1,method:"GET",dataType:"json",url:e.url+"/api/v1/group/"+this.constructorId+"/cover",success:function(e){e.data.map(function(e){switch(e.name){case"subscriber":this.widgets.add(new d(e));break;case"winner":this.widgets.add(new C(e));break;case"date":this.widgets.add(new r(e));break;case"text":this.widgets.add(new w(e));break;case"url":this.widgets.add(new h(e));break;case"timer":this.widgets.add(new m(e));break;case"weather":this.widgets.add(new k(e));break;case"currency":this.widgets.add(new U(e));break;case"statistic":this.widgets.add(new O(e));break;case"commentatorLast":this.widgets.add(new y(e));break;case"reposterLast":this.widgets.add(new V(e));break;case"commentatorDay":this.widgets.add(new b(e));break;case"reposterDay":this.widgets.add(new S(e));break;case"likerDay":this.widgets.add(new x(e));break;case"commentatorLikes":this.widgets.add(new j(e));break;case"traffic":this.widgets.add(new G(e));break;case"image":this.widgets.add(new _(e))}}.bind(this))}.bind(this),error:function(e){401==e.status&&(window.location="/login")}}),this.showHints=window.localStorage.getItem("showHints")||!0;var s=new EnjoyHint({onStart:function(){window.localStorage.setItem("showHints",!1)}}),o=[{"click .sidebar-widgetsAdd":'Нажмите кнопку "Добавить виджет" для добавления первого виджета',nextButton:{text:"Следущее"},skipButton:{text:"Понял!"}}];s.set(o),!0===this.showHints&&s.run()},onShow:function(){this.showChildView("activeWidgets",new N({collection:this.widgets})),this.showChildView("widgets",new F({collection:this.widgets}));var t={collection:this.userGroupsSearch,template:"constructor"};this.showChildView("groups",new H(t)),i.$("#group-name").html('<strong><a target="_blank" href="http://vk.com/club'+this.groupData.social_id+'">'+this.groupData.title+"</a></strong>"),i.$("#coverEditorZone").css("background","url("+e.url+"/api/v1/group/"+this.constructorId+"/cover/background)"),i.$("#file-upload").on("change",function(e){this.uploadFile(e.target.files[0]),i.$("#file-upload").val("")}.bind(this)),i.$("#sidebar").niceScroll({cursorcolor:"#53619d",cursorwidth:4,cursorborder:"none"}),i.$("#sidebarCollapse").on("click",function(){i.$("#sidebar").addClass("active"),i.$(".overlay").fadeIn(),i.$(".collapse.in").toggleClass("in"),i.$("a[aria-expanded=true]").attr("aria-expanded","false")}),this.groupData.is_closed&&i.$.notify("Для закрытых групп недоступны виджеты комментаторов","warn")},hideSidebar:function(e){i.$("#sidebar").removeClass("active"),i.$(".overlay").fadeOut()},uploadFile:function(t){if(t.size>3072e3)i.$.notify("Размер файла до 3х мб","warn");else{var s=window.URL||window.webkitURL,o=this,a=new Image;a.onload=function(){var s=new FormData;s.append("file",t),i.$.ajax({method:"POST",processData:!1,contentType:!1,data:s,url:e.url+"/api/v1/group/"+o.constructorId+"/cover/background",success:function(t){i.$.notify("Фон загружен","success"),i.$("#coverEditorZone").css("background","none"),i.$("#coverEditorZone").css("background","url("+e.url+"/api/v1/group/"+o.constructorId+"/cover/background)")},error:function(e){i.$.notify("Произошла ошибка","error"),401==e.status&&(window.location="/login")}})},a.src=s.createObjectURL(t)}},onChildviewSettingsShow:function(e,t){switch(t.model.get("name")){case"subscriber":this.showChildView("widgetSettings",new n({model:t.model}));break;case"winner":this.showChildView("widgetSettings",new I({model:t.model}));break;case"date":this.showChildView("widgetSettings",new c({model:t.model}));break;case"text":this.showChildView("widgetSettings",new l({model:t.model}));break;case"url":this.showChildView("widgetSettings",new u({model:t.model}));break;case"timer":this.showChildView("widgetSettings",new f({model:t.model}));break;case"weather":this.showChildView("widgetSettings",new g({model:t.model}));break;case"currency":this.showChildView("widgetSettings",new M({model:t.model}));break;case"statistic":this.showChildView("widgetSettings",new W({model:t.model}));break;case"commentatorLast":this.showChildView("widgetSettings",new p({model:t.model}));break;case"reposterLast":this.showChildView("widgetSettings",new T({model:t.model}));break;case"commentatorDay":this.showChildView("widgetSettings",new $({model:t.model}));break;case"reposterDay":this.showChildView("widgetSettings",new D({model:t.model}));break;case"likerDay":this.showChildView("widgetSettings",new L({model:t.model}));break;case"commentatorLikes":this.showChildView("widgetSettings",new v({model:t.model}));break;case"traffic":this.showChildView("widgetSettings",new R({model:t.model}));break;case"image":this.showChildView("widgetSettings",new E({model:t.model}))}},addSubscriber:function(){i.$.notify("Виджет подписчика добавлен","success"),this.widgets.add(new d)},addWinner:function(){i.$.notify("Виджет победителя добавлен","success"),this.widgets.add(new C)},addText:function(){i.$.notify("Виджет текста добавлен","success"),this.widgets.add(new w)},addTextUrl:function(){i.$.notify("Виджет текста по ссылке добавлен","success"),this.widgets.add(new h)},addTimer:function(){i.$.notify("Виджет таймера добавлен","success"),this.widgets.add(new m)},addWeather:function(){i.$.notify("Виджет погоды добавлен","success"),this.widgets.add(new k)},addCourses:function(){i.$.notify("Виджет курса валют добавлен","success"),this.widgets.add(new U)},addStatistic:function(){i.$.notify("Виджет статистики добавлен","success"),this.widgets.add(new O)},addDate:function(){i.$.notify("Виджет даты добавлен","success"),this.widgets.add(new r)},addLastCommentator:function(){this.widgets.find(function(e){return"commentatorLast"===e.get("name")})?i.$.notify("Виджет последнего комментатора уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет последний комментатор добавлен","success"),this.widgets.add(new y))},addLastReposter:function(){this.widgets.find(function(e){return"reposterLast"===e.get("name")})?i.$.notify("Виджет последнего репостер уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет последний репостер добавлен","success"),this.widgets.add(new V))},addDayCommentator:function(){this.widgets.find(function(e){return"commentatorDay"===e.get("name")})?i.$.notify("Виджет комментатора дня уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет комментатор дня добавлен","success"),this.widgets.add(new b))},addDayReposter:function(){this.widgets.find(function(e){return"reposterDay"===e.get("name")})?i.$.notify("Виджет репостер дня уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет репостер дня добавлен","success"),this.widgets.add(new S))},addDayLiker:function(){this.widgets.find(function(e){return"likerDay"===e.get("name")})?i.$.notify("Виджет лайкер дня уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет лайкер дня добавлен","success"),this.widgets.add(new x))},addLikesCommentator:function(){this.widgets.find(function(e){return"commentatorLikes"===e.get("name")})?i.$.notify("Виджет комментатора по лайкам уже добавлен. Максимум 1","warn"):(i.$.notify("Виджет комментатор по лайкам добавлен","success"),this.widgets.add(new j))},addTraffic:function(){i.$.notify("Виджет пробок добавлен","success"),this.widgets.add(new G)},addImage:function(){i.$.notify("Виджет изображения добавлен","success"),this.widgets.add(new _)},saveWidgets:function(){i.$.ajax({async:!1,method:"POST",dataType:"json",headers:{"Content-Type":"application/json; charset=UTF-8"},url:e.url+"/api/v1/group/"+this.constructorId+"/cover",data:JSON.stringify(this.widgets.toJSON(),null,4),success:function(){i.$.notify("Обложка сохранена","success")}})},toggleMarkup:function(e){e.target.checked?i.$("#coverEditorZoneMarkup").css("background","url(/libs/adminlte/dist/img/markup.png)"):i.$("#coverEditorZoneMarkup").css("background","none")},searchGroup:function(e){var t=this.userGroups.filter(function(t){return!(!~t.get("title").toLowerCase().indexOf(e.target.value.toLowerCase())&&!~t.get("social_id").toLowerCase().indexOf(e.target.value.toLowerCase()))});this.userGroupsSearch.reset(t)},showPreview:function(t){document.getElementById("preview-image").src="",i.$(".modalCover_groupImg").loading({circles:3,overlay:!0}),i.$(".js-loading-indicator").css("display","block"),i.$(".js-loading-overlay").css("display","block"),i.$.ajax({async:!0,method:"POST",headers:{"Content-Type":"application/json; charset=UTF-8"},url:e.url+"/api/v1/group/"+this.constructorId+"/preview",data:JSON.stringify(this.widgets.toJSON(),null,4),success:function(e){document.getElementById("preview-image").src="data:image/png;base64,"+e,i.$(".modalCover_groupImg").loading({hide:!0}),i.$(".js-loading-indicator").css("display","none"),i.$(".js-loading-overlay").css("display","none")}})},serializeData:function(){var e=this.model.toJSON();return s.extend(e,{isClosed:this.groupData.is_closed,isStatus:this.userData.permissions.has_stats})},showInfoSubscriber:function(e){i.$("#info-subscriber").show()},showInfoWinner:function(e){i.$("#info-winner").show()},showInfoCommLast:function(e){i.$("#info-last-comment").show()},showInfoCommLikes:function(e){i.$("#info-comm-likes").show()},showInfoCommDay:function(e){i.$("#info-comm-day").show()},showInfoReposterDay:function(e){i.$("#info-reposter-day").show()},showInfoLikerDay:function(e){i.$("#info-liker-day").show()},showInfoReposterLast:function(e){i.$("#info-reposter-last").show()},showInfoDate:function(e){i.$("#info-date").show()},showInfoTimer:function(e){i.$("#info-timer").show()},showInfoWeather:function(e){i.$("#info-weather").show()},showInfoText:function(e){i.$("#info-text").show()},showInfoTextUrl:function(e){i.$("#info-textUrl").show()},showInfoCourses:function(e){i.$("#info-courses").show()},showInfoStatistic:function(e){i.$("#info-statistic").show()},showInfoTraffic:function(e){i.$("#info-traffic").show()},showInfoImage:function(e){i.$("#info-image").show()},hideAllInfo:function(e){"fa fa-question"!==e.target.className&&(i.$("#info-subscriber").hide(),i.$("#info-winner").hide(),i.$("#info-last-comment").hide(),i.$("#info-comm-likes").hide(),i.$("#info-comm-day").hide(),i.$("#info-reposter-day").hide(),i.$("#info-liker-day").hide(),i.$("#info-reposter-last").hide(),i.$("#info-date").hide(),i.$("#info-timer").hide(),i.$("#info-weather").hide(),i.$("#info-text").hide(),i.$("#info-textUrl").hide(),i.$("#info-courses").hide(),i.$("#info-statistic").hide(),i.$("#info-traffic").hide(),i.$("#info-image").hide())}})});